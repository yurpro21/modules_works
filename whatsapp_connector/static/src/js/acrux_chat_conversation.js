odoo.define("whatsapp_connector.conversation",(function(require){"use strict";var core=require("web.core"),Widget=require("web.Widget"),Message=require("whatsapp_connector.message"),session=require("web.session"),framework=require("web.framework");const field_utils=require("web.field_utils");var QWeb=core.qweb,Conversation=Widget.extend({template:"acrux_chat_conversation",events:{"click .acrux_close_conv":"close"},init:function(parent,options){this._super.apply(this,arguments),this.parent=parent,this.options=_.extend({},options),this.context=_.extend({message_from_chatroom:!0},this.parent.context||{},this.options.context),this.session=session,this.update(this.options),this.setMessages(this.options.messages)},start:function(){return this._super().then((()=>this._initRender()))},update:function(options){this.id=options.id||0,this.name=options.name||"",this.number_format=options.number_format,this.status=options.status||"new",this.border_color=options.border_color||"#FFFFFF",this.image_url=options.image_url,this.team_id=options.team_id||[!1,""],this.res_partner_id=options.res_partner_id||[!1,""],this.agent_id=options.agent_id||[!1,""],this.connector_id=options.connector_id||[!1,""],this.connector_type=options.connector_type||"",this.show_icon=options.show_icon||!1,this.allow_signing=options.allow_signing||!1,this.assigned=options.assigned||!1,this.allowed_lang_ids=options.allowed_lang_ids||[],this.chat_type=options.chat_type||"normal",options.last_activity&&(options.last_activity instanceof String||"string"==typeof options.last_activity)?this.last_activity=field_utils.parse.datetime(options.last_activity):this.last_activity=moment(),this.updateMessages(options.messages||[])},_initRender:function(){return this.$number_new_msg=this.$(".o_number_new_msg"),this.$(".acrux_image_perfil").css("box-shadow","0 0 5px 2px "+this.border_color),this.$number_new_msg.addClass("o_hidden"),this.parent.selected_conversation==this&&this.$el.addClass("active"),this.$agent=this.$(".o_acrux_agent"),this.showMessageCount(),Promise.resolve()},destroy:function(){return this.parent.selected_conversation&&this==this.parent.selected_conversation&&(this.parent.$chat_title.html(""),this.parent.$chat_message.html("")),this._super.apply(this,arguments)},setMessages:function(messages){let out=Promise.resolve();return this.messages_ids=new Set,this.messages&&(this.messages.forEach((x=>x.destroy())),this.parent.$chat_message.html("")),messages&&messages instanceof Array&&messages.length>0?messages[0]instanceof Message?(this.messages=messages,this.messages.forEach((x=>this.messages_ids.add(x.id)))):(this.messages=[],out=this.addClientMessage(messages)):this.messages=[],out},addCompanyMessage:function(msg){let out=Promise.resolve();return this.messages_ids.has(msg.id)||(out=this.parent.lockRenderConversation().then((unlock=>(this.messages.length?this.messages[this.messages.length-1].getDate()!=msg.getDate()&&this.parent.$chat_message.append(msg.getDateTmpl()):this.parent.$chat_message.append(msg.getDateTmpl()),this.messages.push(msg),msg.appendTo(this.parent.$chat_message).then((()=>{this.needScroll()&&this.scrollConversation()})).finally(unlock))))),out},showMessages:function(){return this.parent.lockRenderConversation().then((unlock=>{let def,conv_title=QWeb.render("acrux_chat_conv_title",{conversation:this}),$el=this.parent.$chat_message;return this.parent.$chat_title.html(conv_title),$el.empty(),def=this.messages.length?this._syncLoop(0,this.messages,-1,$el).then((()=>{setTimeout((()=>this.scrollConversation()),200)})):Promise.resolve(),this.$el.addClass("active"),this.isMine()&&this.messageSeen(),this.assigned=!1,this.$(".o_acrux_assigned_conv").remove(),def.finally(unlock)}))},addClientMessage:function(messages){let show=this.parent.selected_conversation&&this.parent.selected_conversation===this,def=Promise.resolve();if(messages){if(messages=(messages=messages.map((r=>new Message(this,r)))).filter((r=>!this.messages_ids.has(r.id))),show&&messages.length){const $el=this.parent.$chat_message;def=this.parent.lockRenderConversation().then((unlock=>this._syncLoop(0,messages,this.messages.length-1,$el).then((()=>{this.needScroll()&&this.scrollConversation()})).finally(unlock)))}messages.forEach((r=>{this.messages.push(r),this.messages_ids.add(r.id)}))}return def},addExtraClientMessage:function(messages){let show=this.parent.selected_conversation&&this.parent.selected_conversation===this,def=Promise.resolve(),$el=$("<div>");return messages&&(messages=(messages=messages.map((r=>new Message(this,r)))).filter((r=>!this.messages_ids.has(r.id))),show&&(def=this.parent.lockRenderConversation().then((unlock=>(framework.blockUI(),this._syncLoop(0,messages,-1,$el).then((()=>{if(messages.length){let first_msg,last_msg=messages[messages.length-1];this.messages.length&&(first_msg=this.messages[0],first_msg.getDate()==last_msg.getDate()&&first_msg.$el.prev().hasClass("o_acrux_date")&&first_msg.$el.prev().remove()),this.parent.$chat_message.prepend($el.contents()),messages.forEach((x=>{x.isAttachmentComponent()&&x.res_model_obj.__callMounted()})),last_msg.$el[0].scrollIntoView({block:"nearest",inline:"start"})}})).finally((()=>{framework.unblockUI(),unlock()})))))),messages.length&&def.then((()=>{messages.forEach((r=>this.messages_ids.add(r.id))),this.messages=messages.concat(this.messages)}))),def},_syncLoop:function(i,arr,last_index,$el){let out;return out=i<arr.length?this._syncShow(i,arr,last_index,$el).then((()=>this._syncLoop(i+1,arr,last_index,$el))):Promise.resolve(),out},_syncShow:function(i,arr,last_index,$el){let out_def,r=arr[i];return i?(r.getDate()!=arr[i-1].getDate()&&$el.append(r.getDateTmpl()),out_def=r.appendTo($el)):(last_index>=0?this.messages[last_index].getDate()!=r.getDate()&&$el.append(r.getDateTmpl()):$el.append(r.getDateTmpl()),out_def=r.appendTo($el)),out_def},setMessageError:function(messages){let out=[];if(messages&&this.messages.length){let show=this.parent.selected_conversation&&this.parent.selected_conversation===this;messages.forEach((r=>{let msg=this.messages.find((x=>x.id===r.id));msg&&(out.push(msg),msg.setErrorMessage(r.error_msg),show&&msg.replace())}))}return out},updateMessages:function(messages){if(messages&&this.messages&&this.messages.length){let show=this.parent.selected_conversation&&this.parent.selected_conversation===this;messages.forEach((r=>{let msg=this.messages.find((x=>x.id===r.id));msg&&(msg.update(r),show&&msg.replace())}))}},syncMoreMessage:function(){this.messages.length>=22&&this._rpc({model:"acrux.chat.conversation",method:"build_dict",args:[[this.id],22,this.messages.length],context:this.context}).then((result=>{this.addExtraClientMessage(result[0].messages)}))},needScroll:function(){return this.calculateScrollPosition()>=.75},calculateScrollPosition:function(){let scroll_postion=this.parent.$chat_message.height();return scroll_postion+=this.parent.$chat_message.scrollTop(),scroll_postion/this.parent.$chat_message[0].scrollHeight},scrollConversation:function(){if(this.parent.$chat_message.children().length){let element=this.parent.$chat_message.children().last();element.children().length&&(element=element.children().last()),element[0].scrollIntoView({block:"nearest",inline:"start"})}},calculateMessageCount:function(){const messages=this.messages.filter((msg=>!msg.ttype.startsWith("info")));let lastIndexOf;return lastIndexOf=Array.prototype.findLastIndex?messages.findLastIndex((msg=>msg.from_me)):messages.map((msg=>msg.from_me)).lastIndexOf(!0),messages.length-(lastIndexOf+1)},showMessageCount:function(){const count_new_msg=this.calculateMessageCount();this.$number_new_msg&&["new","current"].includes(this.status)&&(count_new_msg>0?(this.$number_new_msg.text(count_new_msg),this.$number_new_msg.removeClass("o_hidden")):this.$number_new_msg.addClass("o_hidden"))},createMessage:function(options){return this.parent.lockSelectConversation().then((unlock=>{let msg=new Message(this,options),json_data=msg.export_to_vals();return options.custom_field&&(json_data[options.custom_field]=!0),this._rpc({model:"acrux.chat.conversation",method:"send_message",args:[[this.id],json_data],context:this.context}).then((result=>(msg.update(result[0]),this.last_activity=moment(),this.addCompanyMessage(msg).then((()=>msg))))).finally(unlock)}))},messageSeen:function(){this._rpc({model:"acrux.chat.conversation",method:"conversation_send_read",args:[[this.id]],context:this.context},{shadow:!0}).catch((()=>{}))},isMine:function(){return"current"==this.status&&this.agent_id&&this.agent_id[0]==session.uid},getIconClass:function(){let out="";return["apichat.io","chatapi","gupshup"].includes(this.connector_type)&&(out="acrux_whatsapp"),out},close:function(){let prom=Promise.resolve();session.chatroom_release_conv_on_close&&(prom=this._rpc({model:"acrux.chat.conversation",method:"close_from_ui",args:[[this.id]],context:this.context},{shadow:!0}).catch((()=>{}))),prom.finally((()=>{this.parent.deleteConversation({id:this.id})}))},isPrivate:function(){return"private"===this.conv_type}});return Conversation}));