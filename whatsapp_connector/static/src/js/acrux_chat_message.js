odoo.define("whatsapp_connector.message",(function(require){"use strict";const{getMessagingComponent}=require("@mail/utils/messaging_component"),components={AttachmentImage:getMessagingComponent("AttachmentImage"),AttachmentCard:getMessagingComponent("AttachmentCard")},{link}=require("@mail/model/model_field_command"),{Component}=owl;var core=require("web.core"),Widget=require("web.Widget"),field_utils=require("web.field_utils"),session=require("web.session"),AudioPlayer=require("whatsapp_connector.audio_player"),MessageMetadata=require("whatsapp_connector.message_metadata"),QWeb=core.qweb,_t=core._t,Message=Widget.extend({template:"acrux_chat_message",events:{"click a.o_acrux_transcribe":"onTranscribe","click a.o_acrux_translate":"onTranslate"},init:function(parent,options){this._super.apply(this,arguments),this.parent=parent,this.conversation||(this.conversation=parent),this.options=_.extend({},options),this.context=_.extend({},this.parent.context||{},this.options.context),this.update(this.options)},update:function(options){this.options=options,this.id=options.id,this.ttype=options.ttype||"text",this.from_me=options.from_me||!1,this.text=options.text||"",this.res_model=options.res_model||!1,this.res_id=options.res_id||!1,this.error_msg=options.error_msg||!1,this.show_product_text=options.show_product_text||!1,this.res_model_obj=options.res_model_obj,this.date_message=options.date_message||moment(),this.convertDate("date_message"),"location"==this.ttype&&this.createLocationObj(),["image","video","file"].includes(this.ttype)&&this.res_model_obj&&(this.isAttachmentComponent()||(this.res_model_obj=this.createAttachComponent(this.res_model_obj))),this.title_color=options.title_color||"#000000",this.title_color="#FFFFFF"!=this.title_color?this.title_color:"#000000",this.metadata_type=options.metadata_type||null,this.metadata_json=options.metadata_json||null,this.buttons=options.button_ids||[],this.create_uid=options.create_uid||[null,""],this.chat_list=options.chat_list_id||[null,""],this.transcription=options.transcription||"",this.traduction=options.traduction||"",this.textHTML=this.parseHTML(this.text)},willStart:function(){let def=!1;return this.res_model&&!this.res_model_obj&&(def=this._rpc({model:this.res_model,method:"read_from_chatroom",args:[this.res_id],context:this.context}).then((result=>{if(result.length>0)if(this.res_model_obj=result[0],"product.product"==this.res_model){let price=this.res_model_obj.lst_price;price=this.conversation.parent.format_monetary(price),this.res_model_obj.lst_price=price,this.res_model_obj.show_product_text=this.show_product_text}else{let filename=this.res_model_obj.display_name||_t("Unnamed");if(this.res_model_obj.filename=filename,["audio","sticker"].includes(this.ttype))this.res_model_obj.src=`/web/content/${this.res_model_obj.id}`;else{const Attachment=Component.env.services.messaging.modelManager.models["mail.attachment"];let tmp;tmp=Attachment.findFromIdentifyingData(this.res_model_obj),tmp||(tmp=Attachment.insert(this.res_model_obj)),this.res_model_obj=this.createAttachComponent(tmp)}}else"product.product"==this.res_model?this.res_model_obj={display_name:_t("Product not found")}:(this.res_model_obj={display_name:_t("File not found")},this.res_model_obj.filename=this.res_model_obj.display_name)}))),Promise.all([this._super(),def])},start:function(){return this._super().then((()=>this._initRender()))},_initRender:function(){let def=Promise.resolve();return this.res_model_obj&&("product.product"==this.res_model?this.$(".oe_product_details > ul > li").last().remove():(this.$("div.caption").html(""),"audio"==this.ttype&&(def=this.audioController()),this.isAttachmentComponent()?def=this.res_model_obj.mount(this.$("div#o_attach_zone")[0]):this.res_model_obj&&this.$("div#o_attach_zone").html(this._renderCustomObject()))),["apichat_preview_post","ad"].includes(this.metadata_type)&&def.then((()=>this.messageMetadataController())),Promise.all([def]).then((()=>this.makeMessageDragAndDrop()))},_renderCustomObject:function(){let out="";return this.res_model_obj.display_name&&(out=`<i>${this.res_model_obj.display_name}</i>`),out},message_css_class:function(){return this.message_css_class_list().join(" ")},message_css_class_list:function(){return[]},isToDrop:function(){return!1},makeMessageDragAndDrop:function(){this.isToDrop()&&this.$el.draggable({revert:!0,revertDuration:0,containment:this.conversation.parent.$el,appendTo:this.conversation.parent.$el,helper:"clone"})},destroy:function(){return this._super.apply(this,arguments)},export_to_json:function(){let out={};return out.text=this.text,out.from_me=this.from_me,out.ttype=this.ttype,out.res_model=this.res_model,out.res_id=this.res_id,this.id&&(out.id=this.id),out.title_color=this.title_color,this.metadata_type&&(out.metadata_type=this.metadata_type),this.metadata_json&&(out.metadata_json=this.metadata_json),this.buttons&&(out.button_ids=this.buttons),this.create_uid&&(out.create_uid=this.create_uid),this.chat_list[0]&&(out.chat_list_id=this.chat_list),out.transcription=this.transcription,out.traduction=this.traduction,out},export_to_vals:function(){let out=this.export_to_json();return delete out.title_color,out.button_ids&&(out.button_ids=out.button_ids.map((btn=>[0,0,btn]))),out.create_uid&&delete out.create_uid,out.chat_list_id&&out.chat_list_id[0]&&(out.chat_list_id=out.chat_list_id[0]),out},setErrorMessage:function(error_msg){this.error_msg=error_msg},getDateTmpl:function(){return QWeb.render("acrux_chat_chat_date",{widget:this})},getDate:function(){return field_utils.format.date(this.date_message,{type:"datetime"},{timezone:!0})},getHour:function(){let value=this.date_message.clone();return value.add(session.getTZOffset(value),"minutes"),value.format("HH:mm")},audioController:function(){this.audioPlayerWidget&&this.audioPlayerWidget.destroy();let options={context:this.context,src:this.res_model_obj.src};return this.audioPlayerWidget=new AudioPlayer(this,options),this.audioPlayerWidget.appendTo(this.$("#audio_player"))},createLocationObj:function(){if(this.text)try{let text=this.text.split("\n"),loc_obj={};loc_obj.display_name=text[0].trim(),loc_obj.address=text[1].trim(),loc_obj.coordinate=text[2].trim(),text=loc_obj.coordinate.replace("(","").replace(")",""),text=text.split(","),loc_obj.coordinate={x:text[0].trim(),y:text[1].trim()},loc_obj.map_url="https://maps.google.com/maps/search/",loc_obj.map_url+=`${loc_obj.display_name}/@${loc_obj.coordinate.x},${loc_obj.coordinate.y},17z?hl=es`,loc_obj.map_url=encodeURI(loc_obj.map_url),this.location=loc_obj}catch(err){console.log("error location"),console.log(err)}},convertDate:function(field){this[field]&&(this[field]instanceof String||"string"==typeof this[field])&&(this[field]=field_utils.parse.datetime(this[field]))},isAttachmentComponent:function(){return this.res_model_obj&&(this.res_model_obj instanceof components.AttachmentImage||this.res_model_obj instanceof components.AttachmentCard)},createAttachComponent:function(attachment){let attch_list,props={},comp=null;const AttachmentList=Component.env.services.messaging.modelManager.models["mail.attachment_list"],Attachment=Component.env.services.messaging.modelManager.models["mail.attachment"],vals={isAcrux:!0,acruxMessageId:this.id};(attachment=Attachment.findFromIdentifyingData(attachment)).attachmentLists&&0!==attachment.attachmentLists.length?(attch_list=AttachmentList.get(attachment.attachmentLists[0].localId),attch_list.update(vals)):attch_list=AttachmentList.insert(vals);const attachVals=this.getAttachVals();attachVals.attachmentLists=link(attch_list),attachment.update(attachVals);for(const attachmentImage of attachment.attachmentImages)props.attachmentImageLocalId=attachmentImage.localId,comp=new components.AttachmentImage(null,props);for(const attachmentCard of attachment.attachmentCards)props.attachmentCardLocalId=attachmentCard.localId,comp=new components.AttachmentCard(null,props);return comp},canBeAnswered:function(){return!0},canBeDeleted:function(){return!0},hasTitle:function(){return this.from_me&&this.getShowUser()},messageMetadataController:function(){this.messageMetadataWidget&&this.messageMetadataWidget.destroy();let options={metadata_type:this.metadata_type,metadata_json:this.metadata_json};return this.messageMetadataWidget=new MessageMetadata(this,options),this.$(".o_message_metadata_preview").removeClass("o_hidden"),this.messageMetadataWidget.appendTo(this.$(".o_message_metadata_preview"))},getAttachVals:function(){return{isAcrux:!0}},getShowUser:function(){return this.from_me&&!!this.conversation?.parent?.show_user_in_message},canTranscribe:function(){return["audio","video"].includes(this.ttype)&&!!this.conversation?.parent?.can_transcribe},onTranscribe:async function(ev){ev.preventDefault();const res=await this._rpc({model:"acrux.chat.message",method:"transcribe",args:[[this.id],this.conversation.parent.can_transcribe],context:this.context});this.transcription=res,await this.replace()},canTranslate:function(){return!!this.conversation?.parent?.can_translate&&"sticker"!==this.ttype},onTranslate:async function(ev){ev.preventDefault();const parent=this.conversation.parent,res=await this._rpc({model:"acrux.chat.message",method:"translate",args:[[this.id],parent.can_translate,parent.getCurrentLang()],context:this.context});this.traduction=res,await this.replace()},parseHTML:function(text){return(text||"").replace(/(?:^\*|\s\*)(?:(?!\s))((?:(?!\*|\n|<|>).)+)(?:\*)(?=(\s|,|\.|$))/g," <strong>$1</strong>").replace(/(?:^~|\s~)(?:(?!\s))((?:(?!~|\n|<|>).)+)(?:~)(?=(\s|,|\.|$))/g," <del>$1</del>").replace(/(?:^_|\s_)(?:(?!\s))((?:(?!_|\n|<|>).)+)(?:_)(?=(\s|,|\.|$))/g," <em>$1</em>").replace(/(https?:\/\/[^\s]+)/g,(url=>`<a href="${url=url.replace(/<\/?[^>]+(>|$)/g,"")}" target="_blank">${url}</a>`))}});return Message}));