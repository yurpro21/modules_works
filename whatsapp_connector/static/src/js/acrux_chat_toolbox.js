odoo.define("whatsapp_connector.toolbox",(function(require){"use strict";require("@whatsapp_connector/components/toolbox");const{getMessagingComponent}=require("@mail/utils/messaging_component"),ToolBoxComponent=getMessagingComponent("ToolBoxComponent");var Widget=require("web.Widget"),core=require("web.core"),Emojis=require("whatsapp_connector.emojis"),session=require("web.session"),StandaloneFieldManagerMixin=require("web.StandaloneFieldManagerMixin"),BooleanToggle=require("web.basic_fields").BooleanToggle;const{FieldMany2One}=require("web.relational_fields");var QWeb=core.qweb,_t=core._t,ToolBox=Widget.extend(StandaloneFieldManagerMixin,{template:"acrux_chat_toolbox",events:{"click .o_chat_toolbox_send":"sendMessage","keypress .o_chat_toolbox_input textarea":"onKeypress","keydown .o_chat_toolbox_input textarea":"onKeydown","paste .o_chat_toolbox_input textarea":"onPaste","input .o_chat_toolbox_input textarea":"onInput","click .o_chat_button_add_attachment":"clickAddAttachment","click .o_attachment_delete":"deleteAttachment","click .o_chat_button_emoji":"toggleEmojis","click span.o_acrux_emoji":"addEmoji","change input.o_input_file":"changeAttachment","click .o_attachment_view":"viewAttachment","click .o_chat_button_translate":"translate"},init:function(parent,options){this._super.apply(this,arguments),this.parent=parent,this.options=_.extend({},options),this.context=_.extend({},this.parent.context||{},this.options.context),StandaloneFieldManagerMixin.init.call(this),this.signing_active=this.options.signing_active||!1},willStart:function(){return this._super().then((()=>this.getUserPreference())).then((()=>this.createFakeRercord())).then((()=>this.processUserPreference())).then((()=>this.langSelector()))},start:function(){return this._super().then((()=>this._initRender()))},_initRender:function(){let classes=["o_chat_toolbox_done","o_chat_toolbox_container","o_chat_toolbox_send","o_chat_button_add_attachment","o_chat_button_emoji","o_chat_toolbox_user_preference","o_chat_button_translate","o_chat_toolbox_message_signing","o_chat_toolbox_lang_selector","o_chat_empty_btn"];classes="."+classes.join(", ."),this.$input=this.$(".o_chat_toolbox_text_field"),this.$attachment_button=this.$(".o_chat_button_add_attachment"),this.$attachment_zone=this.$(".o_toolbox_file_uploader"),this.$other_inputs=this.$(classes),this.$write_btn=this.$(".o_chat_toolbox_write"),this.$write_btn.click((()=>this.blockClient())),this.$send_btn=this.$(".o_chat_toolbox_send"),this.$(".o_chat_toolbox_done").click((()=>this.releaseClient())),this.$emoji_btn=this.$(".o_chat_button_emoji");let emoji_html=QWeb.render("acrux_chat_emojis"),emoji_list=Emojis.data.map((emoji=>`<span data-source="${emoji}" class="o_acrux_emoji">${emoji}</span>`));return this.$el.popover({trigger:"manual",animation:!0,html:!0,title:function(){return"nada"},container:this.$el,placement:"top",content:`<div class="o_acrux_emoji_container">${emoji_list.join("\n")}</div>`,template:emoji_html}).on("inserted.bs.popover",(()=>{setTimeout((()=>this.fix_popover_position()),20)})),$(window).resize((()=>{this.fix_popover_position()})),this.$user_preference=this.$(".o_chat_toolbox_user_preference"),this.$message_signing=this.$(".o_chat_toolbox_message_signing"),this.$toolbox_container=this.$(".o_chat_toolbox_container"),this.$write_done_btn=this.$(".o_chat_write_done_btn"),this.$input_lang=this.$(".o_chat_toolbox_text_translated"),this.$lang_selector=this.$(".o_chat_toolbox_lang_selector"),this.$lang_comp=this.$lang_selector.add(this.$(".o_chat_button_translate")),this.$lang_comp=this.$lang_comp.add(this.$input_lang.parent()),Promise.resolve().then((()=>this.signingWidget.appendTo(this.$message_signing))).then((()=>this.langWidget.appendTo(this.$lang_selector)))},destroy:function(){return this.component&&(this.component.destroy(),this.component=void 0),this._super.apply(this,arguments)},on_attach_callback:function(){if(this.component)return;let props={parent_widget:this};this.component=new ToolBoxComponent(null,props),this.component.mount(this.$attachment_zone[0])},blockClient:function(){let out;return out=this.parent.selected_conversation?this._rpc({model:this.parent.model,method:"block_conversation",args:[[this.parent.selected_conversation.id]],context:this.context}).then((conv=>(this.$write_btn.addClass("o_hidden"),this.$other_inputs.removeClass("o_hidden"),this.check_component_visibility(),this.parent.upsertConversation(conv),this.parent.showConversations().then((()=>this.parent.selected_conversation.showMessages())).then((()=>{this.parent.selected_conversation.$el.addClass("active"),this.parent.tabsClear()}))))).catch((()=>{"new"==this.parent.selected_conversation.status&&this.parent.removeSelectedConversation()})):Promise.reject(),out},releaseClient:function(){let out;return out=this.parent.selected_conversation&&this.parent.selected_conversation.isMine()?this._rpc({model:this.parent.model,method:"release_conversation",args:[[this.parent.selected_conversation.id]],context:this.context}).then((()=>{this.parent.removeSelectedConversation(),this.parent.showConversationPanel()})):Promise.reject(),out},do_show:function(){this._super(),this.parent.selected_conversation?this.parent.selected_conversation.isMine()?(this.$write_btn.addClass("o_hidden"),this.$other_inputs.removeClass("o_hidden"),this.check_component_visibility()):("current"!==this.parent.selected_conversation.status?this.$write_btn.removeClass("o_hidden"):this.$write_btn.addClass("o_hidden"),this.$other_inputs.addClass("o_hidden"),this.component&&this.component.attachment.value&&this.component._onAttachmentRemoved({})):(this.$write_btn.addClass("o_hidden"),this.$other_inputs.addClass("o_hidden"),this.component&&this.component.attachment.value&&this.component._onAttachmentRemoved({})),this.$el.popover("hide")},check_component_visibility:function(){if(this.parent.selected_conversation.allow_signing?this.$message_signing.removeClass("o_hidden"):this.$message_signing.addClass("o_hidden"),this.parent.can_translate)if(this.parent.selected_conversation.allowed_lang_ids.length){const lang_ids=this.parent.selected_conversation.allowed_lang_ids;this.fakeRecord.data.lang=lang_ids[0],this.fakeRecord.fields.lang.domain=[["id","in",lang_ids]],this.langWidget.reinitialize(lang_ids[0]).then((()=>this.langWidget.reset(this.langWidget.record))),this.$lang_comp.removeClass("o_hidden"),lang_ids.length>1?this.$lang_selector.removeClass("o_hidden"):this.$lang_selector.addClass("o_hidden")}else this.langWidget._setValue(!1),this.$lang_comp.addClass("o_hidden");else this.$lang_comp.addClass("o_hidden"),this.langWidget._setValue(!1)},sendMessage:async function(event){this.$input.prop("disabled",!0),this.$input_lang.prop("disabled",!0),this.$send_btn.prop("disabled",!0);let out=Promise.resolve(),options={from_me:!0},text=this.$input.val().trim(),traduction="";if(this.langWidget?.value?.data?.id&&this.parent.can_translate&&(traduction=this.$input_lang.val().trim()),event&&(event.preventDefault(),event.stopPropagation()),""!==traduction&&(options.traduction=traduction),""!==text&&(options.ttype="text",options.text=text),this.component.attachment.value){let attachment=this.component.attachment.value;attachment.mimetype.includes("image")?options.ttype="image":attachment.mimetype.includes("audio")?options.ttype="audio":attachment.mimetype.includes("video")?options.ttype="video":options.ttype="file",options.res_model="ir.attachment",options.res_id=attachment.id,options.res_model_obj=attachment}return options.ttype&&(options=this.sendMessageHook(options),out=this.parent.selected_conversation.createMessage(options).then((msg=>(this.$input.prop("disabled",!1),this.$input_lang.prop("disabled",!1),text=traduction="",this.$input.focus(),this.component.attachment.value=null,this.parent.upsertConversation(),this.parent.showConversations().then((()=>msg)))))),out.finally((()=>{this.$input.prop("disabled",!1),this.$input_lang.prop("disabled",!1),this.$send_btn.prop("disabled",!1),this.enableDisplabeAttachBtn(),this.setInputText(text,traduction)}))},sendMessageHook:function(options){return options},onKeypress:function(event){13!==event.which||event.shiftKey||(event.preventDefault(),event.stopPropagation(),event.currentTarget.classList.contains("o_chat_toolbox_text_translated")?this.translate().then((()=>this.$input.focus())):this.sendMessage())},onKeydown:function(_event){},onInput:function(event){const{target:textarea}=event;textarea.style.height="auto";const newHeight=textarea.scrollHeight-(textarea.offsetHeight-textarea.clientHeight);textarea.style.height=Math.min(newHeight,250)+"px",textarea.style.overflow=newHeight>250?"auto":"hidden"},onPaste:function(event){let clipboardData=event.originalEvent.clipboardData||window.clipboardData;if(clipboardData){var items=clipboardData.items;for(let index in items){const item=items[index];if("file"===item.kind){event.stopPropagation(),event.preventDefault(),this.component.attachment.value||this.component.uploadFile({target:{files:[item.getAsFile()]}});break}}}},toggleEmojis:function(){this.$el.popover("toggle"),setTimeout((()=>this.$(".o_acrux_emoji_popover:visible").on("mouseleave",(()=>{this.$el.popover("hide")}))),50)},addEmoji:function(event){const inputRef=this.$input[0],startPos=inputRef.selectionStart,endPos=inputRef.selectionEnd,firstText=inputRef.value.substring(0,startPos),lastText=inputRef.value.substring(endPos,inputRef.value.length),text=$(event.target).data("source");this.setInputText(`${firstText}${text}${lastText}`),this.$input.focus(),inputRef.selectionStart=startPos+text.length,inputRef.selectionEnd=startPos+text.length},fix_popover_position:function(){let popover=this.$(".o_acrux_emoji_popover");if(popover.length){let popover_data=popover[0].getBoundingClientRect(),el_data=this.$el[0].getBoundingClientRect(),msg_data=this.parent.$chat_message[0].getBoundingClientRect();popover_data.height>msg_data.height?(popover.css("max-height",msg_data.height),popover.css("height",msg_data.height),popover.offset({top:el_data.top-msg_data.height})):popover_data.height<msg_data.height&&(popover.css("max-height",""),popover.css("height",""),popover.offset({top:el_data.top-popover.height()})),popover.css("z-index",100)}},getUserPreference:function(){return this._rpc({model:"res.users",method:"read",args:[[session.uid],["chatroom_signing_active"]],context:this.context}).then((result=>{this.signing_active=result[0].chatroom_signing_active}))},changeStatusNotify:function(data){this.signing_active=!!data.signing_active,this.signingNoUpdate=!0,this.signingWidget._setValue(this.signing_active).then((()=>this.signingNoUpdate=!1))},createFakeRercord:async function(){const recordID=await this.model.makeRecord("res.users",[{name:"signing_active",type:"boolean",value:this.signing_active},{name:"lang",relation:"res.lang",type:"many2one",value:!1}]);this.fakeRecord=this.model.get(recordID)},processUserPreference:function(){this.signingWidget=new BooleanToggle(this,"signing_active",this.fakeRecord,{attrs:{modifiers:{},string:_t("Sign")}}),this._registerWidget(this.fakeRecord.id,"signing_active",this.signingWidget)},langSelector:function(){this.langWidget=new FieldMany2One(this,"lang",this.fakeRecord,{mode:"edit",attrs:{modifiers:{},can_create:!1,can_write:!1,options:{no_open:!0},string:_t("Lang")},additionalContext:{active_test:!1}}),this._registerWidget(this.fakeRecord.id,"lang",this.langWidget)},_confirmChange:async function(id,fields,event){return StandaloneFieldManagerMixin._confirmChange.call(this,id,fields,event).then((()=>{const prom=[];return!this.signingNoUpdate&&fields.includes("signing_active")&&prom.push(this._rpc({model:"res.users",method:"write",args:[[session.uid],{chatroom_signing_active:this.signingWidget.value}],context:this.context})),Promise.all(prom)}))},clickAddAttachment:function(){this.component.openBrowserFileUploader()},needDisableInput:function(attachment){return!(attachment.isImage||attachment.isVideo)},enableDisplabeAttachBtn:function(){if(this.$attachment_button.prop("disabled",Boolean(this.component.attachment.value)),this.component.attachment.value){let attachment=this.component.attachment.value;this.needDisableInput(attachment)&&(this.setInputText(""),this.$input.prop("disabled",!0),this.$input_lang.prop("disabled",!0),this.$emoji_btn.prop("disabled",!0)),this.$send_btn.focus()}else this.$emoji_btn.prop("disabled",!1),this.$input_lang.prop("disabled",!1),this.$input.prop("disabled",!1),this.$input.focus()},setInputText:function(text,translatedText){this.$input.prop("disabled")||this.$input.prop("readonly")||(this.$input.val(text),this.onInput({target:this.$input[0]}),this.$input_lang.val(translatedText||""),this.onInput({target:this.$input_lang[0]}))},translate:async function(){const text=this.$input_lang.val().trim(),traduction=await this.doTranslate(text);traduction&&text&&this.setInputText(traduction,text)},doTranslate:async function(text){let traduction=null;if(""!==text&&this.parent.can_translate&&this.langWidget?.value?.data?.id){const lang_id=this.langWidget?.value?.data?.id,ai_config_id=this.parent.can_translate,conversation_id=this.parent.selected_conversation.id;traduction=await this._rpc({model:"acrux.chat.message",method:"translate_text",args:[ai_config_id,text,lang_id,conversation_id],context:this.context})}return traduction},getCurrentLang:function(){return this.langWidget?.value?.data?.id}});return ToolBox}));