odoo.define("whatsapp_connector.form_view",(function(require){"use strict";var Widget=require("web.Widget"),dom=require("web.dom"),_t=require("web.core")._t,FormView=Widget.extend({init:function(parent,options){this._super.apply(this,arguments),this.parent=parent,this.options=_.extend({},options),this.context=_.extend({},this.parent.context||{},this.options.context),this.parent.selected_conversation&&(this.context.default_conversation_id=this.parent.selected_conversation.id),this.model=this.options.model,this.form_name=this.options.form_name,this.record=this.options.record,this.action_manager=this.options.action_manager,this.title=this.options.title,this.acrux_form_widget=null,this.action={},this.created_date=new Date,this.env=this.parent.env},start:function(){return this._super().then((()=>this.do_action(this.getDoActionDict(),this.getOptions()))).then((()=>{const currentController=this.action_manager.actionService.currentController;return this.action=currentController.action,this.acruxComponent=currentController,this.action.controllers.form&&(this.acrux_form_widget=currentController.acrux_comp.componentRef.comp.controllerRef.comp.widget,this.acrux_form_widget.acrux_widget=this,this._showAcruxFormView()),currentController.action}))},destroy:function(){return this._super()},getDoActionDict:function(){return{type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:this.model,views:[[this.form_name,"form"]],target:"inline",context:this.context,res_id:this.record[0],flags:this.getDoActionFlags(),name:this.title}},getDoActionFlags:function(){let flags={withControlPanel:!1,footerToButtons:!1,hasSearchView:!1,hasSidebar:!1,mode:"edit",searchMenuTypes:!1};return this.record[0]&&(flags.mode="readonly"),flags},getOptions:function(){const out={clearBreadcrumbs:!1};return this.action_manager.actionService.currentController.acrux_comp&&(out.stackPosition="replaceCurrentAction"),out},_showAcruxFormView:function(){let $buttons=$("<div>");return dom.append(this.$el,this.acrux_form_widget.$el,{in_DOM:!0,callbacks:[{widget:this},{widget:this.acrux_form_widget}]}),this.acrux_form_widget.renderButtons($buttons),$buttons.find(".o_form_button_create").click((()=>this._onCreate())),$buttons.find(".o_form_button_edit").click((()=>this._onEdit())),this.$el.prepend($buttons.contents()),this.$el.children().first().css("padding","5px"),this.$el.children().first().css("background","white"),this.options.searchButton&&this._addSearchButton(),this.makeDropable()&&this.makeFormDragAndDrop(),Promise.resolve()},makeDropable:function(){return!1},acceptDrop:function(_ui){return!1},handlerDradDrop:function(_event,_ui){return Promise.resolve()},makeFormDragAndDrop:function(){this.$el.css("padding","0.5em"),this.$el.droppable({drop:(event,ui)=>this.handlerDradDrop(event,ui),accept:ui=>this.acceptDrop(ui),activeClass:"drop-active",hoverClass:"drop-hover"})},_addSearchButton:function(){this.$el.children().first().children().append('<button type="button" class="btn btn-primary o_form_button_search">'+(this.options.searchButtonString||_t("Search"))+"</button>"),this.$el.find(".o_form_button_search").click((()=>this._onSearchChatroom()))},_onSearchChatroom:function(){let context=_.extend({chatroom_wizard_search:!0},this.context),action={type:"ir.actions.act_window",view_type:"form",view_mode:"list",res_model:this.model,domain:this._getOnSearchChatroomDomain(),views:[[!1,"list"]],target:"new",context,flags:{action_buttons:!1,withBreadcrumbs:!1},_chatroomSelectRecord:record=>{if(record)return this.recordUpdated(record).then((()=>this.replace())).then((()=>this._onSearchChatroomCallBack(record))).then(record)}};return this.do_action(action)},_getOnSearchChatroomDomain:function(){return[]},_onSearchChatroomCallBack:function(_record){return Promise.resolve()},on_attach_callback:function(){this.$el.css("height","100%"),this.$el.css("display","flex"),this.$el.css("flex-direction","column"),this.$el.children().first().css("position","relative"),this.$el.children().first().css("height","92%"),this.$el.children().first().css("overflow","auto"),this._fix_attach()},_fix_attach:function(){this.$(".o_form_sheet").eq(0).css("padding","0 1em"),this.$(".o_form_sheet").children().first().css("margin","0"),this.$(".o_FormRenderer_chatterContainer").hide()},recordUpdated:function(record){return this._fix_attach(),record&&record.data&&this.record&&this.record[0]!=record.data.id?this.recordChange(record):Promise.resolve()},recordChange:function(_record){return Promise.resolve()},recordSaved:function(_record){return Promise.resolve()},isExpired:function(){return new Date-this.created_date>=108e5},isSameRecord:function(record_id){return this.record[0]==record_id},_onCreate:function(){this.old_record=Array.from(this.record)},_onEdit:function(){this.old_record=null},discardChange:function(){if(this.old_record){let options=this.getDoActionFlags();options.currentId=this.old_record[0],options.ids=[this.old_record[0]],options.context=this.context,options.modelName=this.model,options.mode="readonly",this.acrux_form_widget.reload(options),this.old_record=null}},update:function(recordId){let out=Promise.resolve();return this.acrux_form_widget&&(out=this.acrux_form_widget.update({currentId:recordId})),out},_context_hook:function(){this.parent.selected_conversation?.isPrivate()&&("default_mobile"in this.context&&delete this.context.default_mobile,"default_phone"in this.context&&delete this.context.default_phone)},isMyController:function(jsId){return this.action&&this.action.controllers&&this.action.controllers.form&&this.action.controllers.form.jsId===jsId}});return FormView}));