odoo.define("whatsapp_connector.acrux_chat",(function(require){"use strict";require("bus.BusService");var core=require("web.core"),AbstractAction=require("web.AbstractAction"),session=require("web.session"),chat=require("whatsapp_connector.chat_classes"),config=require("web.config"),Dialog=require("web.Dialog"),field_utils=require("web.field_utils"),_t=core._t,chat_is_read_resolve=null,chat_is_read=new Promise((r=>chat_is_read_resolve=r)),QWeb=core.qweb,AcruxChatAction=AbstractAction.extend({contentTemplate:"acrux_chat_action",hasControlPanel:!1,events:{"click .o_acrux_chat_notification .fa-close":"_onCloseNotificationBar","click .o_acrux_chat_request_permission":"_onRequestNotificationPermission","click .o_acrux_chat_item":"selectConversation","click .navbar-toggler.show_thread":"showChatPanel","click .navbar-toggler.show_conv":"showConversationPanel","click .navbar-toggler.show_option":"showRightPanel","click .navbar-toggler.hide_option":"hideRightPanel","click li#tab_partner":"tabPartner","click li#tab_conv_info":"tabConvInfo","click li#tab_conv_states":"tabConvStates","click li#tab_ai_interface":"tabAiInterface","click div#acrux_chat_main_view":"globalClick","click .acrux_order_new_conversation":"reorderConversations"},init:function(parent,action,options){this._super.apply(this,arguments),this.action_manager=parent,this.env=parent.env,this.model="acrux.chat.conversation",this.domain=[],this.action=action,this.options=options||{},this.notification_bar=window.Notification&&"default"===window.Notification.permission,this.selected_conversation=this.options.selected_conversation,this.conversation_used_fields=[],this.conversations=this.options.conversations||[],this.default_answers=this.options.default_answers||[],this.context=this.action.context,this.defaultChannelID=this.options.active_id||this.action.context.active_id||this.action.params.default_active_id||"acrux_chat_live_id";let widget_options={context:this.context};this.conversationOrder=this.call("local_storage","getItem","chatroomConversationOrder",{current:"desc",other:"asc"}),this.toolbox=new chat.ToolBox(this,widget_options),this.product_search=new chat.ProductSearch(this,widget_options),this.init_conversation=new chat.InitConversation(this,widget_options),this.user_status=new chat.UserStatus(this,widget_options),odoo.debranding_new_name?this.company_name=odoo.debranding_new_name:this.company_name="Odoo",this.load_more_message=!1,this.selected_conversation_locked=!1,this.conversation_render_locked=!1,this.can_transcribe=!1,this.can_translate=!1},startBus:function(){this.call("bus_service","onNotification",this,(notifications=>this.onNotification(notifications)))},willStart:function(){return Promise.all([this._super(),session.is_bound]).then((()=>(this.current_company_id=session.user_context.allowed_company_ids[0],Promise.all([this.getDefaultAnswers(),this.getRequiredViews(),this.getCurrency(),this.getConversationUsedFields(),this.getTranscriptionModel(),this.getTranslateModel(),session.user_has_group("whatsapp_connector.group_chat_show_user_in_message").then((hasGroup=>{this.show_user_in_message=hasGroup}))]))))},start:function(){return this._super().then((()=>this._initRender())).then((()=>this.startBus())).then((()=>{if(this.user_status.isActive())return this.changeStatusView()})).then((()=>chat_is_read_resolve(this))).then((()=>core.bus.trigger("chatroom:create",this)))},_initRender:function(){return this._buildJqueryObjects(),this.$chat_message.on("scroll",(event=>{if(0==$(event.target).scrollTop()&&this.selected_conversation&&this.load_more_message)return this.selected_conversation.syncMoreMessage()})),core.bus.on("acrux_chat_msg_seen",this,this.chatMessageSeen),config.device.isMobile&&this.showConversationPanel(),this.$(".o_sidebar_right").find("ul.nav.nav-tabs").find("li > a").click((e=>{this._getMaximizeTabs().includes($(e.target).attr("href"))||this.product_search.maximize()})),this.onResizeWindow(),this.onWindowShow(),Promise.all([this.toolbox.appendTo(this.$chat_content),this.product_search.prependTo(this.$sidebar_right),this.init_conversation.appendTo(this.$tab_init_chat),this.user_status.appendTo(this.$sidebar_left.find(".o_acrux_group").first()),this.showDefaultAnswers(),this.addChatroomPopover()]).then((()=>{this.$chat_title=this.$(".o_conv_title"),this.toolbox.do_hide(),this.renderOrderIcon(this.$(".acrux_order_new_conversation")[0],"asc",this.conversationOrder.other),this.renderOrderIcon(this.$(".acrux_order_current_conversation")[0],"asc",this.conversationOrder.current)}))},_buildJqueryObjects:function(){this.$chat_content=this.$(".o_acrux_chat_content"),this.$sidebar_left=this.$(".o_sidebar_left"),this.$sidebar_right=this.$(".o_sidebar_right"),this.$first_main_tab=this.$(".o_sidebar_right").find("ul.nav.nav-tabs").children("li").first().find("a"),this.$first_content_tab=this.$(".o_sidebar_right #acrux_tabs .tab-content div").first(),this.$chat_message=this.$("div.o_chat_thread"),this.$current_chats=this.$(".o_acrux_chat_items.o_current_chats"),this.$new_chats=this.$(".o_acrux_chat_items.o_new_chats"),this.$chat_title=this.$(".o_conv_title"),this.$tab_default_answer=this.$("div#tab_content_default_answer > div.o_group"),this.$tab_init_chat=this.$("div#tab_content_init_chat"),this.$tab_content_partner=this.$("div#tab_content_partner > div.o_group"),this.$tab_content_conv_info=this.$("div#tab_content_conv_info > div.o_group"),this.$tab_content_conv_states=this.$("div#tab_content_conv_states > div.o_group"),this.$tab_content_ai_interface=this.$("div#tab_content_ai_interface > div.o_group"),this.$first_main_tab.addClass("active"),this.$first_content_tab.addClass("active")},destroy:function(){return this.$el&&(this.$chat_message.off("scroll"),core.bus.off("acrux_chat_msg_seen")),core.bus.trigger("chatroom:destroy"),this._super.apply(this,arguments)},do_show:function(){this._super.apply(this,arguments),this.action_manager.do_push_state({action:this.action.id})},on_attach_callback:function(){this._super(...arguments),this.toolbox&&this.toolbox.on_attach_callback()},getServerConversation:function(){return this._rpc({model:this.model,method:"search_active_conversation",args:[],context:this.context}).then((result=>{this.upsertConversation(result)}))},getCurrency:function(){return this._rpc({model:"res.company",method:"read",args:[[this.current_company_id],["currency_id"]],context:this.context}).then((result=>{this.currency_id=result[0].currency_id[0],this.currency=session.get_currency(this.currency_id)}))},getDefaultAnswers:function(){return this._rpc({model:"acrux.chat.default.answer",method:"get_for_chatroom",args:[],context:this.context}).then((result=>{result.forEach((r=>this.default_answers.push(new chat.DefaultAnswer(this,r))))}))},getRequiredViews:function(){return Promise.all([this._rpc({model:this.model,method:"check_object_reference",args:["","view_whatsapp_connector_conversation_chatroom_form"],context:this.context}).then((result=>{this.conversation_info_forms=result[1]})),this._rpc({model:this.model,method:"check_object_reference",args:["","view_whatsapp_connector_conversation_kanban"],context:this.context}).then((result=>{this.conversation_kanban_view=result[1]})),this._rpc({model:this.model,method:"check_object_reference",args:["","view_whatsapp_connector_ai_interface_form"],context:this.context}).then((result=>{this.ai_interface_form_view=result[1]}))])},getTranscriptionModel:async function(){return this._rpc({model:"acrux.chat.ai.config",method:"search_read",args:[[["operation_key","=","audio_transcriptions"]],["name"],0,1],context:this.context}).then((result=>{result.length&&(this.can_transcribe=result[0].id)}))},getTranslateModel:async function(){const transalate_ref=await this._rpc({model:this.model,method:"check_object_reference",args:["","data_ai_translate"],context:this.context});if(transalate_ref?.length&&transalate_ref[1]){const translate_model=await this._rpc({model:"acrux.chat.ai.config",method:"read",args:[[transalate_ref[1]],["name","active"]],context:this.context});translate_model?.length&&translate_model[0].active&&(this.can_translate=translate_model[0].id)}},getConversationUsedFields:function(){return this._rpc({model:this.model,method:"get_fields_to_read",args:[],context:this.context}).then((result=>{this.conversation_used_fields=result}))},upsertConversation:function(convList){const order=this.conversationOrder;if(convList){Array.isArray(convList)||(convList=[convList]);for(const convData of convList){const conv=this.conversations.find((conv=>conv.id==convData.id));if(conv)conv.update(convData);else{const newConv=new chat.Conversation(this,convData);"lock_desc"===("current"===newConv.status?order.current:order.other)?this.conversations.unshift(newConv):this.conversations.push(newConv)}}}const currentConversations=this.conversations.filter((conv=>"current"===conv.status)),notCurrentConversations=this.conversations.filter((conv=>"current"!==conv.status)),orderFn=(a,b,criteria)=>{let out;return out="desc"===criteria?a.last_activity.isBefore(b.last_activity):a.last_activity.isAfter(b.last_activity),out?1:-1};["asc","desc"].includes(order.current)&&currentConversations.sort(((a,b)=>orderFn(a,b,order.current))),["asc","desc"].includes(order.other)&&notCurrentConversations.sort(((a,b)=>orderFn(a,b,order.other))),this.conversations=[...currentConversations,...notCurrentConversations]},reorderConversations:function(event){const target=event.currentTarget||event.target;if(target){const orderChange={desc:"lock_desc",lock_desc:"asc",asc:"lock_asc",lock_asc:"desc"},fildName=target.classList.contains("acrux_order_new_conversation")?"other":"current",lastOrder=this.conversationOrder[fildName],newOrder=this.conversationOrder[fildName]=orderChange[this.conversationOrder[fildName]];this.call("local_storage","setItem","chatroomConversationOrder",this.conversationOrder),this.upsertConversation(),this.renderOrderIcon(target,lastOrder,newOrder)}return this.showConversations()},renderOrderIcon:function(target,lastOrder,newOrder){const orderIcon={desc:"fa-arrow-up",asc:"fa-arrow-down",lock_desc:"fa-lock",lock_asc:"fa-lock"},orderTitle={desc:_t("New Chats Up"),asc:_t("New Chats Down"),lock_desc:_t("Static Order"),lock_asc:_t("Static Order")};target.querySelector("i").classList.replace(orderIcon[lastOrder],orderIcon[newOrder]),target.title=orderTitle[newOrder]},format_monetary:function(val){return val=field_utils.format.monetary(val,null,{currency:this.currency}),$("<span>").html(val).text()},chatMessageSeen:function(){this.selected_conversation&&this.selected_conversation.isMine()&&this.selected_conversation.messageSeen()},onResizeWindow:function(){let original_device=config.device.isMobile;$(window).resize((()=>{config.device.isMobile!=original_device&&(config.device.isMobile?this.showConversationPanel():(this.showChatPanel(),this.$sidebar_left.removeClass("d-none")),original_device=config.device.isMobile)}))},onWindowShow:function(){document.addEventListener("visibilitychange",(function(_ev){document.hidden||core.bus.trigger("acrux_chat_msg_seen")}))},changeStatusView:function(){let out=Promise.resolve();return this.conversations.forEach((x=>x.destroy())),this.conversations=[],this.user_status.isActive()&&(out=this.getServerConversation().then((()=>this.showConversations()))),this.selected_conversation=null,this.toolbox.do_hide(),this.tabsClear(),out},showConversations:function(){let defs=[];return this.$new_chats.html(""),defs=[...defs,...this.getNewConversation().map((x=>this.renderNewConversation(x)))],this.$current_chats.html(""),defs=[...defs,...this.getCurrentConversation().map((x=>this.renderCurrentConversation(x)))],this.shouldShowAllConversations()&&(defs=[...defs,...this.getDoneConversation().map((x=>this.renderNewConversation(x)))],defs=[...defs,...this.getCurrentNotMineConversation().map((x=>this.renderNewConversation(x)))]),Promise.all(defs)},renderNewConversation:function(conv){return conv.appendTo(this.$new_chats)},renderCurrentConversation:function(conv){return conv.appendTo(this.$current_chats)},showConversationPanel:function(){config.device.isMobile&&this.$chat_content.hide(),this.$sidebar_left.removeClass("d-none")},showChatPanel:function(){config.device.isMobile&&this.$sidebar_left.addClass("d-none"),this.$chat_content.show()},showRightPanel:function(){config.device.isMobile||this.$sidebar_left.addClass("d-none"),this.$chat_content.hide()},hideRightPanel:function(){config.device.isMobile||this.$sidebar_left.removeClass("d-none"),this.$chat_content.show()},showDefaultAnswers:async function(){const target=this.$("div.default_table_answers");return this._showDefaultAnswers(this.default_answers,target)},_showDefaultAnswers:async function(default_answers,target){let index=0,row=$('<div class="row-default">'),padding=default_answers.length%2;padding=2-padding;let func_default_answer=arr=>{if(index<arr.length)return arr[index].appendTo(row).then((()=>(++index,index%2==0&&(row.appendTo(target),row=$('<div class="row-default">')),func_default_answer(arr))));if(padding){for(let i=0;i<padding;++i)$('<div class="cell-default">').appendTo(row);row.appendTo(target)}return Promise.resolve()};return func_default_answer(default_answers)},getNewConversation:function(){return this.conversations.filter((x=>"new"==x.status))},getCurrentConversation:function(){return this.conversations.filter((x=>x.isMine()))},getDoneConversation:function(){return this.conversations.filter((x=>"done"==x.status))},getCurrentNotMineConversation:function(){return this.conversations.filter((x=>"current"==x.status&&!x.isMine()))},shouldShowAllConversations:function(){return!1},lockRenderConversation:async function(){return new Promise((res=>{this.conversation_render_locked?setTimeout((async()=>{await this.lockRenderConversation(),res((()=>{this.conversation_render_locked=!1}))}),50):(this.conversation_render_locked=!0,res((()=>{this.conversation_render_locked=!1})))}))},lockSelectConversation:async function(){return new Promise((res=>{this.selected_conversation_locked?setTimeout((async()=>{await this.lockSelectConversation(),res((()=>{this.selected_conversation_locked=!1}))}),50):(this.selected_conversation_locked=!0,res((()=>{this.selected_conversation_locked=!1})))}))},selectConversation:function(event){const conversation_id=$(event.currentTarget).data("id");return this.lockSelectConversation().then((unlock=>{let finish=Promise.resolve();const conv_id=this.conversations.find((x=>x.id==conversation_id));return conv_id&&this.selected_conversation!=conv_id&&(this.selected_conversation&&this.selected_conversation.$el.removeClass("active"),this.selected_conversation=conv_id,this.load_more_message=!1,finish=this.selected_conversation.showMessages(),finish.then((()=>this.load_more_message=!0)),this.tabsClear()),finish.then((()=>{this.toolbox.do_show(),this.toolbox.$input.focus(),this.showChatPanel()})).finally(unlock)}))},setNewPartner:function(partner_id){if(partner_id&&partner_id.data&&partner_id.data.id&&partner_id.data.id!=this.selected_conversation.res_partner_id[0])if((partner_id=Object.assign({},partner_id)).data.name=partner_id.data.display_name,this.res_partner_form)this.res_partner_form.recordChange(partner_id).then((()=>{this.saveDestroyWidget("res_partner_form")}));else{let tmp_widget=new chat.ResPartnerForm(this,{});tmp_widget.recordChange(partner_id).then((()=>{tmp_widget.destroy()}))}},isChatroomTab:function(jsId){return this._isChatroomTab("res_partner_form",jsId)},_isChatroomTab:function(name,jsId){let out=!1;return this&&this[name]&&(out=this[name].isMyController(jsId)),out},tabPartner:function(_event,data){let out=Promise.reject();if(this.selected_conversation){const partner_id=this.selected_conversation.res_partner_id;this.saveDestroyWidget("res_partner_form");const options={context:_.extend({conversation_id:this.selected_conversation.id},this.context),res_partner:partner_id,action_manager:this.action_manager,searchButton:!0,searchButtonString:_t("Match with Existing Partner"),title:_t("Partner")};this.res_partner_form=new chat.ResPartnerForm(this,options),this.$tab_content_partner.empty(),out=this.res_partner_form.appendTo(this.$tab_content_partner)}else this.$tab_content_partner.html(QWeb.render("acrux_empty_tab"));return out.then((()=>data&&data.resolve&&data.resolve())),out.catch((()=>data&&data.reject&&data.reject())),out},tabConvInfo:function(_event,data){let out=Promise.reject();if(this.selected_conversation)if(this.selected_conversation.isMine()){let conv_info=[this.selected_conversation.id,this.selected_conversation.name];this.saveDestroyWidget("conv_info_form");let options={context:this.context,conv_info,action_manager:this.action_manager,form_name:this.conversation_info_forms,title:_t("Info")};this.conv_info_form=new chat.ConversationForm(this,options),this.$tab_content_conv_info.empty(),out=this.conv_info_form.appendTo(this.$tab_content_conv_info)}else this.$tab_content_conv_info.html(QWeb.render("acrux_empty_tab",{notYourConv:!0}));else this.$tab_content_conv_info.html(QWeb.render("acrux_empty_tab"));return out.then((()=>data&&data.resolve&&data.resolve())),out.catch((()=>data&&data.reject&&data.reject())),out},tabAiInterface:function(_event,data){let out=Promise.reject();if(this.selected_conversation)if(this.selected_conversation.isMine()){this.saveDestroyWidget("ai_interface_form");const options={context:_.extend({conversation_id:this.selected_conversation.id},this.context),action_manager:this.action_manager,form_name:this.ai_interface_form_view,title:_t("AI")};this.ai_interface_form=new chat.AiInterfaceForm(this,options),this.$tab_content_ai_interface.empty(),out=this.ai_interface_form.appendTo(this.$tab_content_ai_interface)}else this.$tab_content_ai_interface.html(QWeb.render("acrux_empty_tab",{notYourConv:!0}));else this.$tab_content_ai_interface.html(QWeb.render("acrux_empty_tab"));return out.then((()=>data&&data.resolve&&data.resolve())),out.catch((()=>data&&data.reject&&data.reject())),out},tabConvStates:function(_event,data){let out=Promise.reject();this.saveDestroyWidget("conv_states_kanban");let options={context:this.context,action_manager:this.action_manager,form_name:this.conversation_kanban_view,title:_t("Status")};return this.conv_states_kanban=new chat.ConversationKanban(this,options),this.$tab_content_conv_states.empty(),out=this.conv_states_kanban.appendTo(this.$tab_content_conv_states),out.then((()=>data&&data.resolve&&data.resolve())),out.catch((()=>data&&data.reject&&data.reject())),out},addChatroomPopover:function(){let emoji_html=QWeb.render("acrux_chat_popover");return this.$el.popover({trigger:"manual",animation:!0,html:!0,title:function(){return"nada"},container:this.$("div#acrux_chat_main_view"),placement:"left",content:this.popoverOptions.bind(this),template:emoji_html}).on("show.bs.popover",(()=>{setTimeout(this.fixPopoverPosition.bind(this),10)})),$(window).resize(this.fixPopoverPosition.bind(this)),Promise.resolve()},fixPopoverPosition:function(){if(!this.popoverOption)return"";let popover=this.$(".o_acrux_chat_popover");if(popover.length){let popover_data=popover[0].getBoundingClientRect(),msg_data=this.popoverOption.event.currentTarget.getBoundingClientRect(),position={top:msg_data.top+msg_data.height,left:msg_data.left+msg_data.width};position.top+popover_data.height>window.visualViewport.height&&(position.top=msg_data.top-msg_data.height-popover_data.height),position.left+popover_data.width>window.visualViewport.width&&(position.left=msg_data.left-msg_data.width-popover_data.width),popover.offset(position),popover.css("z-index",100)}},popoverOptions:function(){return""},globalClick:function(e){const ignoreIdList=this.globalClickIgnoreIdList();this.$("div.popover").each((function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||ignoreIdList.includes($(e.target).attr("id"))||$(this).popover("hide")}))},globalClickIgnoreIdList:function(){return["o_chat_button_emoji"]},onNotification:function(data){data&&data.forEach((d=>this.notifactionProcessor(d)))},notifactionProcessor:function(data){"delete_conversation"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.onDeleteConversation(m))),"delete_taken_conversation"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.onDeleteTakenConversation(m))),"new_messages"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.onNewMessage(m))),"init_conversation"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.onInitConversation(m))),"change_status"===data.type&&data.payload.forEach((m=>this.onChangeStatus(m))),"update_conversation"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.onUpdateConversation(m))),"assign_conversation"===data.type&&this.user_status.isActive()&&data.payload.forEach((m=>this.addConversation(m))),"error_messages"===data.type&&this.user_status.isActive()&&this.onErrorMessages(data.payload)},onNewMessage:async function(d){let conv=null;if(("new"==d.status||this.conversations.find((x=>x.id===d.id)))&&(this.upsertConversation(d),conv=this.conversations.find((x=>x.id===d.id)),await conv.addClientMessage(d.messages),await this.showConversations(),conv&&(conv.showMessageCount(),this.selected_conversation===conv&&!document.hidden&&conv.isMine()&&conv.messageSeen(),document.hidden&&("all"===d.desk_notify||"mines"===d.desk_notify&&conv.agent_id&&conv.agent_id[0]==session.uid)))){const msg=d.messages.filter((x=>!x.from_me));msg&&msg.length&&this.call("bus_service","sendNotification",{title:_t("New messages from ")+conv.name})}return conv},onUpdateConversation:function(d){let conv=this.conversations.find((x=>x.id===d.id)),def_out=Promise.resolve(conv);if(conv){let old_partner=conv.res_partner_id;this.upsertConversation(d),def_out=this.showConversations().then((()=>conv)),this.$tab_content_partner.parent().hasClass("active")&&this.selected_conversation==conv&&(conv.res_partner_id[0]!=old_partner[0]?this.tabPartner({currentTarget:!1}):this.res_partner_form.acrux_form_widget.reload()),this.$tab_content_conv_info.parent().hasClass("active")&&this.conv_info_form.acrux_form_widget.reload()}return this.$tab_content_conv_states.parent().hasClass("active")&&this.conv_states_kanban.acrux_form_widget.reload(),def_out},onDeleteConversation:function(conv_data){let out;return out=conv_data.agent_id[0]!=session.uid?this.deleteConversation(conv_data):Promise.resolve(),out},onDeleteTakenConversation:function(conv_data){let out;return out=conv_data.agent_id[0]==session.uid?this.deleteConversation(conv_data):Promise.resolve(),out},onInitConversation:function(conv_data){return this.addConversation(conv_data).then((conv=>{let out=Promise.resolve(conv);return this.showConversationPanel(),conv?.el&&(out=this.selectConversation({currentTarget:conv.el}).then((()=>conv))),out}))},addConversation:function(conv_data){this.upsertConversation(conv_data);const conv=this.conversations.find((x=>x.id===conv_data.id));return this.selected_conversation&&this.selected_conversation.id!=conv.id&&conv.setMessages(conv_data.messages),this.showConversations().then((()=>conv))},onChangeStatus:function(data){data.agent_id[0]==session.uid&&(this.user_status.changeStatusNotify(data),this.toolbox.changeStatusNotify(data),this.changeStatusView())},onErrorMessages:function(error_messages){let message_found,conv_to_show,msg_to_show,conv_found=[],show_conv=!0;if(error_messages.forEach((conv_data=>{let conv=this.conversations.find((x=>x.id==conv_data.id));conv&&(conv.update(conv_data),message_found=conv.setMessageError(conv_data.messages),conv_found.push(conv),this.selected_conversation&&this.selected_conversation.id==conv.id?show_conv=!1:"current"==conv.status&&(conv_to_show=conv,message_found.length&&(msg_to_show=message_found[0])))})),conv_found.length){let msg=_t("Error in conversation with ");conv_found.forEach(((val,index)=>{index&&(msg+=", "),msg+=val.name})),Dialog.alert(this,msg,{confirm_callback:()=>{show_conv&&conv_to_show&&this.selectConversation({currentTarget:conv_to_show.el}).then((()=>{msg_to_show.el.scrollIntoView({block:"nearest",inline:"start"})}))}})}},deleteConversation:function(conv_data){let conv=this.conversations.find((x=>x.id==conv_data.id));return this.conversations=this.conversations.filter((x=>x.id!=conv_data.id)),conv&&(conv==this.selected_conversation?this.removeSelectedConversation():conv.destroy()),Promise.resolve(conv)},removeSelectedConversation:function(){this.selected_conversation&&(this.conversations=this.conversations.filter((x=>x.id!=this.selected_conversation.id)),this.selected_conversation.destroy(),this.selected_conversation=null),this.toolbox.do_hide(),this.tabsClear()},tabNeedReload:function(){return!this.$tab_default_answer.parent().hasClass("active")&&!this.$tab_init_chat.hasClass("active")&&!this.$tab_content_conv_states.parent().hasClass("active")},saveDestroyWidget:function(name){if(this&&this[name]){let tmp_form=this[name];this[name]=null,tmp_form.destroy()}},tabsClear:function(){this.tabNeedReload()&&this.$first_main_tab.trigger("click"),this.saveDestroyWidget("res_partner_form"),this.saveDestroyWidget("conv_info_form")},_onCloseNotificationBar:function(){this.$(".o_acrux_chat_notification").slideUp()},_onRequestNotificationPermission:function(event){event.preventDefault(),this.$(".o_acrux_chat_notification").slideUp();var def=window.Notification&&window.Notification.requestPermission();def&&def.then((value=>{"granted"!==value?this.call("bus_service","sendNotification",{title:_t("Permission denied"),message:this.company_name+_t(" will not have the permission to send native notifications on this device.")}):this.call("bus_service","sendNotification",{title:_t("Permission granted"),message:this.company_name+_t(" has now the permission to send you native notifications on this device.")})}))},_getMaximizeTabs:function(){return["#tab_content_partner","#tab_content_conv_info"]},getCurrentLang:function(){return this.toolbox.getCurrentLang()}});return core.action_registry.add("acrux.chat.create_new_conversation",(function(self,action,_options){self.services.action.doAction({type:"ir.actions.act_window_close"}).then((()=>chat_is_read.then((widget=>widget.init_conversation.createConversation({context:action.context})))))})),core.action_registry.add("acrux.chat.conversation_tag",AcruxChatAction),{AcruxChatAction,is_ready:chat_is_read}}));