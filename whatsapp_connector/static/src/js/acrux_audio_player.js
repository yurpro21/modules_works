odoo.define("whatsapp_connector.audio_player",(function(require){"use strict";var Widget=require("web.Widget"),core=require("web.core"),session=require("web.session"),_t=core._t,AudioPlayer=Widget.extend({template:"acrux_audio_player",events:{"loadeddata audio":"onLoadData","error audio":"onError","timeupdate audio":"onTimeUpdate","ended audio":"onEnded","click .play > a":"onPlayPause","click .progress":"changeProgress","click .download":"onDownload"},init:function(parent,options){this._super.apply(this,arguments),this.parent=parent,this.options=_.extend({},options),this.context=_.extend({},this.parent.context||{},this.options.context),this.src=options.src,this.ignoreTimeUpdateEvent=!1},willStart:function(){return this._super().then((()=>{this.promise&&this.resolve(),this.promise=new Promise((resolve=>this.resolve=resolve))}))},start:function(){return this._super().then((()=>this._initRender()))},_initRender:function(){let out=Promise.resolve();return this.$player=this.$(".o_acrux_audio_player"),this.$audio=this.$("audio"),this.audio_obj=this.$audio?this.$audio[0]:{},this.$progress=this.$player.find(".progress"),this.$time=this.$player.find(".time"),this.$progress_play=this.$progress.find(".playback"),this.$player_play=this.$player.find(".play > a"),this.$player.addClass("o_hidden"),Object.keys(this.events).forEach((key=>{if(key.includes("audio")){const str=key.split(" ");this.$audio.on(str[0],this[this.events[key]].bind(this))}})),this.src&&(out=this.promise,this.$audio[0].load(),setTimeout((()=>{this.promise&&(this.resolve(),this.promise=null)}),2e3)),out},destroy:function(){this.$audio&&Object.keys(this.events).forEach((key=>{if(key.includes("audio")){const str=key.split(" ");this.$audio.off(str[0])}})),this.promise&&(this.resolve(),this.promise=null),this._super()},setAudio:function(audio){this.src=audio},onLoadData:function(event){const audio=event.target;this.$player.removeClass("o_hidden"),this.$time.html(this.calculateTime(audio.duration)),this.resolve(),this.promise=null},onError:function(){this.$player.html(_t("Audio not found")),this.$player.removeClass("o_acrux_audio_player"),this.$player.removeClass("o_hidden"),this.resolve(),this.promise=null},onTimeUpdate:function(event){const audio=event.target;let percentage=100*audio.currentTime/audio.duration;percentage=Math.round(percentage),this.$progress_play.width(percentage+"%"),this.ignoreTimeUpdateEvent||this.$time.html(this.calculateTime(audio.currentTime))},onEnded:function(event){this.ignoreTimeUpdateEvent=!0;const audio=event.target;audio.currentTime=0,this.$player_play.html("▶"),this.$time.html(this.calculateTime(audio.duration))},onPlayPause:function(event){event.preventDefault(),this.ignoreTimeUpdateEvent=!1,this.audio_obj.paused?(this.audio_obj.play(),$(event.target).html("⏸️")):(this.audio_obj.pause(),$(event.target).html("▶"))},changeProgress:function(event){let relative_position,percentage;this.ignoreTimeUpdateEvent=!1,relative_position=event.pageX-this.$progress.offset().left,percentage=relative_position/this.$progress.outerWidth(),Number.isFinite(this.audio_obj.duration)&&(this.audio_obj.currentTime=this.audio_obj.duration*percentage)},calculateTime:function(num){let out="";if(!isNaN(num)&&Number.isFinite(num)){let zero=x=>x<10?"0"+x:x,minutes=Math.floor(num/60),seconds=Math.round(num)%60,hours=Math.floor(minutes/60);minutes=Math.round(minutes)%60,hours&&(out=zero(hours)+":"),out+=zero(minutes)+":"+zero(seconds)}return out},onDownload:function(){if(this.src)if(this.src.startsWith("blob:")){const link=document.createElement("a");link.href=this.src,link.download="audio.oga",link.click()}else window.location=session.url(this.src,{download:!0})}});return AudioPlayer}));